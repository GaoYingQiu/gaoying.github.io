<!DOCTYPE html>
<html>
<head hexo-theme='https://volantis.js.org/#2.6.6'>
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
    
  
  <!-- 渲染优化 -->
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- 页面元数据 -->
  
    <title>Xmpp协议 - littleWhale</title>
  
  
    <meta name="description" content="基于TCP的长连接。在使用 TCP 长连接的 IM 服务设计中，往往都会涉及到心跳。心跳一般是指某端(绝大多数情况下是客户端)每隔一定时间向对端发送自定义指令，以判断双方是否存活，因其按照一定间隔发送，类似于心跳，故被称为心跳指令。">
  

  <!-- feed -->
  

  <!-- import meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13/css/all.min.css">
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">

  

  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css">
  

  

  <!-- import link -->
  

  
  
    
<link rel="stylesheet" href="/css/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
</head>

<body>
  
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>
<header class="l_header shadow blur">
  <div class='container'>
  <div class='wrapper'>
    <div class='nav-sub'>
      <p class="title"></p>
      <ul class='switcher nav-list-h'>
        <li><a class="s-comment fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li><a class="s-toc fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
      </ul>
    </div>
		<div class="nav-main">
      
        
        <a class="title flat-box" target="_self" href='/'>
          
          
          
            littleWhale
          
          
        </a>
      

			<div class='menu navigation'>
				<ul class='nav-list-h'>
          
          
          
            
            
              <li>
                <a class="flat-box" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-book fa-fw'></i>首页
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/paint/
                  
                  
                  
                    id="paint"
                  >
                  <i class='fas fa-tags fa-fw'></i>胖橙的画廊
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=https://mi.aliyun.com/shop/43068
                  
                    rel="external nofollow noopener noreferrer"
                  
                  
                    target="_blank"
                  
                  
                    id="https:mialiyuncomshop43068"
                  >
                  <i class='fas fa-link fa-fw'></i>域名出售
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
          
				</ul>
			</div>

      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fas fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="搜索..." />
        </form>
      </div>

			<ul class='switcher nav-list-h'>
				
					<li><a class="s-search fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li>
          <a class="s-menu fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a>
          <ul class="menu-phone list-v navigation white-box">
            
              
            
              <li>
                <a class="flat-box" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-book fa-fw'></i>首页
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/paint/
                  
                  
                  
                    id="paint"
                  >
                  <i class='fas fa-tags fa-fw'></i>胖橙的画廊
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=https://mi.aliyun.com/shop/43068
                  
                    rel="external nofollow noopener noreferrer"
                  
                  
                    target="_blank"
                  
                  
                    id="https:mialiyuncomshop43068"
                  >
                  <i class='fas fa-link fa-fw'></i>域名出售
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
            
          </ul>
        </li>
			</ul>
		</div>
	</div>
  </div>
</header>

<script>setLoadingBarProgress(40);</script>



  <div class="l_body nocover">
    <div class='body-wrapper'>
      

<div class='l_main'>
  

  
    <article id="post" class="post white-box reveal shadow article-type-post" itemscope itemprop="blogPost">
      


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h1 class="title">
    <a href="/2016/05/15/xmpp/">
      Xmpp协议
    </a>
  </h1>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a href="http://littleWhale.xyz" target="_blank" rel="nofollow noopener">
    <img src="https://qyanblog.oss-cn-shenzhen.aliyuncs.com/blog_avatar.JPG">
    <p>高颖</p>
  </a>
</div>

            
          
            
              
  
  <div class='new-meta-item category'>
    <a href='/categories/%E6%8A%80%E6%9C%AF/' rel="nofollow">
      <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>
      <p>技术</p>
    </a>
  </div>


            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：2016年5月15日</p>
  </a>
</div>

            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


      <section class="article typo">
        <div class="article-entry" itemprop="articleBody">
          
          <p>基于TCP的长连接。在使用 TCP 长连接的 IM 服务设计中，往往都会涉及到心跳。心跳一般是指某端(绝大多数情况下是客户端)每隔一定时间向对端发送自定义指令，以判断双方是否存活，因其按照一定间隔发送，类似于心跳，故被称为心跳指令。</p>
<a id="more"></a>
<h4 id="保持心跳的必要"><a href="#保持心跳的必要" class="headerlink" title="保持心跳的必要"></a>保持心跳的必要</h4><p>服务器需要及时清理无效连接以减轻负载，另一方面也是业务的需求，如游戏副本中服务器需要及时处理玩家掉线带来的问题。</p>
<h4 id="为什么TCP-KeepAlive-不能用于检测"><a href="#为什么TCP-KeepAlive-不能用于检测" class="headerlink" title="为什么TCP KeepAlive 不能用于检测"></a>为什么TCP KeepAlive 不能用于检测</h4><p>TCP KeepAlive用于检测连接的死活，心跳机制用于检查双方的存活状态。考虑一种情况，某台服务器因为某些原因导致负载超高，CPU 100%，无法响应任何业务请求，但是使用 TCP 探针则仍旧能够确定连接状态，这就是典型的连接活着但业务提供方已死的状态，对客户端而言，这时的最好选择就是断线后重新连接其他服务器，而不是一直认为当前服务器是可用状态，一直向当前服务器发送些必然会失败的请求。</p>
<h4 id="心跳的做法"><a href="#心跳的做法" class="headerlink" title="心跳的做法"></a>心跳的做法</h4><p>每隔 30 秒心跳一次，15 秒内没有收到心跳回包则认为当前连接已失效，断开连接并进行重连。连接可靠性可在心跳超时 n 次后才判定当前连接不可用，这样做可以减少心跳连接的次数，减少流量。</p>
<h3 id="消息可达"><a href="#消息可达" class="headerlink" title="消息可达"></a>消息可达</h3><p>在移动网络下，丢包，网络重连等情况非常之多，为了保证消息的可达，一般需要做消息回执和重发机制。参考易信，每条消息会最多会有3次重发，超时时间为15秒，同时在发送之前会检测当前连接状态，如果当前连接并没有正确建立，缓存消息且定时检查(每隔2秒检查一次，检查15次)。所以一条消息在最差的情况下会有2分钟左右的重试时间，以保证消息的可达。</p>
<p>因为重发的存在，接受端偶尔会收到重复消息，这种情况下就需要接收端进行去重。通用的做法是每条消息都带上自己唯一的message id(一般是uuid)。</p>
<h3 id="消息加密"><a href="#消息加密" class="headerlink" title="消息加密"></a>消息加密</h3><p>为了保证协议不容易被破解，市面上几乎所有主流IM都会对协议进行加密传输。常见的流程和HTTPS加密相似:建立连接后，客户端和服务器进行进行协商，最终客户端获得一个当前Sessino的秘钥，后续的数据传输都通过这个秘钥进行加解密。一般出于效率的考虑都会采用流式加密，如RC4。而前期协商过程则推荐使用RSA等非对称加密以增加破解难度。</p>
<h3 id="IM协议包"><a href="#IM协议包" class="headerlink" title="IM协议包"></a>IM协议包</h3><p>包头：<br>struct PackHeader<br>{<br>    int32<em>t     length</em>;    //包长度<br>    int32<em>t     serial</em>;    //包序列号<br>    int32<em>t     command</em>;   //包请求类型<br>    int32<em>t     code</em>;      //返回码<br>};</p>
<h3 id="IM聊天App-登录后要做得事情"><a href="#IM聊天App-登录后要做得事情" class="headerlink" title="IM聊天App  登录后要做得事情"></a>IM聊天App  登录后要做得事情</h3><ul>
<li>好友列表</li>
<li>好友个人信息</li>
<li>群组列表</li>
<li>群成员列表</li>
<li>群成员个人信息</li>
<li>离线消息</li>
</ul>
<p>1，客户端永远只更新比本地缓存数据新的数据。<br>2、登录时候LBS可放在登录后或者网络空闲时去请求。<br>3、有些数据只是在请求时候去更新UI.</p>
<h3 id="使用XMpp协议的一个聊天应用程序，当程序退到后台的时候，如果想要继续接收到聊天信息或icon显示badge-该怎么做？GCDAsyncSocket"><a href="#使用XMpp协议的一个聊天应用程序，当程序退到后台的时候，如果想要继续接收到聊天信息或icon显示badge-该怎么做？GCDAsyncSocket" class="headerlink" title="使用XMpp协议的一个聊天应用程序，当程序退到后台的时候，如果想要继续接收到聊天信息或icon显示badge, 该怎么做？GCDAsyncSocket"></a>使用XMpp协议的一个聊天应用程序，当程序退到后台的时候，如果想要继续接收到聊天信息或icon显示badge, 该怎么做？GCDAsyncSocket</h3><p>You need to set the VoIP flag in your app’s (appname)-info.plist file, and then in</p>
<p>(void)xmppStream:(XMPPStream <em>)sender socketWillConnect:(AsyncSocket </em>)socket<br>You’ll need to set the socket stream flags to include kCFStreamNetworkServiceTypeVoIP:</p>
<p> CFReadStreamSetProperty([socket getCFReadStream], kCFStreamNetworkServiceType, kCFStreamNetworkServiceTypeVoIP);<br> CFWriteStreamSetProperty([socket getCFWriteStream], kCFStreamNetworkServiceType, kCFStreamNetworkServiceTypeVoIP);<br>Then, your app will be woken up briefly when a new XMPP message arrives. In your normal</p>
<p>(void)xmppStream:(XMPPStream <em>)sender didReceiveMessage:(XMPPMessage </em>)message<br>handler, you would want to create a local notification for the message if you are backgrounded (you can keep track of background state via UIApplicationDidEnterBackgroundNotification and UIApplicationWillEnterForegroundNotification). The local notification handler can set the application badge number, etc (just like you would for a push notification).</p>
<p>EDIT<br>Newer versions of the XMPP Framework (specifically, GCDAsyncSocket) now support a call to make this easier, so you can just have:</p>
<ul>
<li>(void)xmppStream:(XMPPStream <em>)sender socketWillConnect:(GCDAsyncSocket </em>)socket<br>{<br>  // Tell the socket to stay around if the app goes to the background (only works on apps with the VoIP background flag set)<br>  [socket performBlock:^{<pre><code>[socket enableBackgroundingOnSocket];
</code></pre>  }];<br>}<br><a href="http://stackoverflow.com/questions/5257580/iphone-xmpp-app-run-background" target="_blank" rel="noopener">在这篇文章中你或许能找到答案</a>  不得不说StackOverFlow真是个好东西。</li>
</ul>
<h3 id="聊聊IOS后台"><a href="#聊聊IOS后台" class="headerlink" title="聊聊IOS后台"></a>聊聊IOS后台</h3><p>应用程序进入后台状态不久后转入暂停状态。在这种状态下，应用程序不执行任何代码，并有可能在任意时候从内存中删除。应用程序提供特定的服务，用户可以请求后台执行时间，以提供这些服务。<br>三种类型的可以运行在后以，<br>1.音乐<br>2.location<br>3.voip<br>声明你需要的后台任务<br>Info.plist中添加UIBackgroundModes键值，它包含一个或多个string的值，包括<br>audio:在后台提供声音播放功能，包括音频流和播放视频时的声音<br>location：在后台可以保持用户的位置信息<br>voip：在后台使用VOIP功能</p>
<p>实现VOIP应用：<br>VOIP程序需要稳定的网络去连接和它相关的服务，这样它才能接到来电和其他相关的数据。系统允许VOIP程序被挂断并提供组件去监听它们的sockets，而不是在任意时候都处于唤醒状态。设置VOIP应用程序如下：<br>A、 添加UIBackgroundModes中的VOIP键值<br>B、 为VOIP设置一个应用程序socket<br>C、 在移出后台之前，调用setKeepAliveTimeout:handler:方法去建立一个定期执行的handler，你的应用程序可以运行这个handler来保持服务的连接。<br>(<br>BOOL backgroundAccepted = [[UIApplication sharedApplication] setKeepAliveTimeout:600 handler:^{ [self backgroundHandler]; }];<br> if (backgroundAccepted)<br> {<br>      NSLog(@”VOIP backgrounding accepted”);<br> }<br>为了防止断连，voip程序需要定期被唤醒去检查它的服务。为了容易实现这个行为，IOS通过使用（UIApplication setKeepAliveTimeout:handler:）方法建立一个特殊的句柄。你可以在applicationDidEnterBackground方法中建立该句柄。一旦建立，系统至少会在超时之前调用该句柄一次，来唤醒你的应用程序。<br>这个keep-alive handler在后台执行，必须尽快的返回参数，它有最多30秒的时间来执行所需的任务，如果这段时间内句柄没有返回，那么系统将终止应用程序。<br>当你建立了handler之后，确定应用程序所需的最大超时。系统保证会在最大超时之前调用handler，但是这个时间是不确定的，所以你的handler必须在你申明的超时之前做好执行程序的准备<br>)<br>D、 设置你的audio session去处理这种切换</p>
<h4 id="安排Local-Notification的传递"><a href="#安排Local-Notification的传递" class="headerlink" title="安排Local Notification的传递"></a>安排Local Notification的传递</h4><p>UILocalNotification类提供了一种方法来传递local notifications。和push notifications需要设置remote server不同，local notifications 在程序中安排并在当前的设备上执行。满足如下条件可以使用该能力：<br>1、一个基于时间的程序，可以在将来特定的时间让程序post 一个alert，比如闹钟<br>2、一个在后台运行的程序，post 一个local notification去引起用户的注意<br>为了安排local notification 的传递，需要创建一个UILocalNotification的实例，并设置它，使用UIApplication类方法来安排它。Local notification对象包含了所要传递的类型（sound，alert，或者badge）和时间何时呈现） 。UIApplication类方法提供选项去确定是立即传递还是在指定的时间传递。<br>Listing 4-3 Scheduling an alarm notification  </p>
<ul>
<li>(void)scheduleAlarmForDate:(NSDate<em>)theDate<br>{<br>UIApplication</em> app = [UIApplication sharedApplication];<br>NSArray<em> oldNotifications = [app scheduledLocalNotifications];<br>// Clear out the old notification before scheduling a new one.<br>if ([oldNotifications count] &gt; 0)<br>[app cancelAllLocalNotifications];<br>// Create a new notification.<br>UILocalNotification</em> alarm = [[[UILocalNotification alloc] init] autorelease];<br>if (alarm)<br>{<br>alarm.fireDate = theDate;<br>alarm.timeZone = [NSTimeZone defaultTimeZone];<br>alarm.repeatInterval = 0;<br>alarm.soundName = @”alarmsound.caf”;<br>alarm.alertBody = @”Time to wake up!”;<br>[app scheduleLocalNotification:alarm];<br>}<br>}<br>(可以最多包含128个 local notifications active at any given time, any of which can be configured to repeat at a specified interval.)如果在调用该notification的时候，程序已经处于前台，那么application：didReceiveLocalNotification：方法将取而代之。</li>
</ul>
<h3 id="voip与socket实现后台推送"><a href="#voip与socket实现后台推送" class="headerlink" title="voip与socket实现后台推送"></a>voip与socket实现后台推送</h3><h4 id="1-找到该文件-添加该项"><a href="#1-找到该文件-添加该项" class="headerlink" title="1.找到该文件,添加该项"></a>1.找到该文件,添加该项</h4><p>(1)蜗牛帮-Info.plist(2)Required background modes它的item：App provides Voice over IP services</p>
<h4 id="2-在socket连接成功代理里面"><a href="#2-在socket连接成功代理里面" class="headerlink" title="2.在socket连接成功代理里面"></a>2.在socket连接成功代理里面</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-(void)socket:(GCDAsyncSocket *)sock didConnectToHost:(NSString *)host port:(uint16_t)port//建立连接成功后执行的代理</span><br><span class="line">&#123;</span><br><span class="line">    //后台挂起voip</span><br><span class="line">    [socket performBlock:^&#123;</span><br><span class="line">        [socket enableBackgroundingOnSocket];</span><br><span class="line">    &#125;];</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-在收到socket消息代理里面"><a href="#3-在收到socket消息代理里面" class="headerlink" title="3.在收到socket消息代理里面"></a>3.在收到socket消息代理里面</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">-(void)socket:(GCDAsyncSocket *)sock didReadData:(NSData *)data withTag:(long)tag//接收到消息执行的代理。</span><br><span class="line">&#123;</span><br><span class="line">    [socket readDataWithTimeout:-1 tag:0];//这句话太重要了</span><br><span class="line">    UIApplication *application=[UIApplication sharedApplication];</span><br><span class="line">    <span class="keyword">if</span> (application.applicationState==UIApplicationStateBackground||application.applicationState==UIApplicationStateInactive )</span><br><span class="line">    &#123;</span><br><span class="line">        NSArray *oldNotifications=[application scheduledLocalNotifications];</span><br><span class="line">        <span class="keyword">if</span> ([oldNotifications count]&gt;0)</span><br><span class="line">        &#123;</span><br><span class="line">            [application cancelAllLocalNotifications];</span><br><span class="line">        &#125;</span><br><span class="line">        UILocalNotification *alarm=[[UILocalNotification alloc] autorelease];</span><br><span class="line">        <span class="keyword">if</span> (alarm)</span><br><span class="line">        &#123;</span><br><span class="line">            alarm.fireDate=[NSDate date];</span><br><span class="line">            alarm.timeZone=[NSTimeZone defaultTimeZone];</span><br><span class="line">            alarm.repeatInterval=0;</span><br><span class="line">            [Single sharedSingle].iconNumber++;</span><br><span class="line">            alarm.applicationIconBadgeNumber=[Single sharedSingle].iconNumber;</span><br><span class="line">            alarm.soundName=@<span class="string">"alarmsound.caf"</span>;</span><br><span class="line">            alarm.alertBody=[jsonDictionary valueForKey:@<span class="string">"sendmsg"</span>];</span><br><span class="line">            [application scheduleLocalNotification:alarm];</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-挂起时，本操作是为了600秒重写连接一次socket，保持socket在线"><a href="#4-挂起时，本操作是为了600秒重写连接一次socket，保持socket在线" class="headerlink" title="4.//挂起时，本操作是为了600秒重写连接一次socket，保持socket在线"></a>4.//挂起时，本操作是为了600秒重写连接一次socket，保持socket在线</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">- (void)applicationDidEnterBackground:(UIApplication *)application</span><br><span class="line">&#123;</span><br><span class="line">    [[UIApplication sharedApplication] setKeepAliveTimeout:600 handler:^&#123; [[NSNotificationCenter defaultCenter]postNotificationName:@<span class="string">"CreatSocket"</span> object:nil userInfo:nil];&#125;];</span><br><span class="line">&#125;</span><br><span class="line">-(void)creatSocket</span><br><span class="line">&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">if</span> (![[Single sharedSelfMemberID] isEqualToString:@<span class="string">""</span>]) &#123;//登陆了</span><br><span class="line">       </span><br><span class="line">        [Single sharedSingle].socket.delegate=self;</span><br><span class="line">        [Single sharedSingle].socket.delegateQueue=dispatch_get_main_queue();</span><br><span class="line"></span><br><span class="line">        NSError *err = nil;</span><br><span class="line">        <span class="keyword">if</span>(![socket connectToHost:socketURL onPort:socketPort error:&amp;err])</span><br><span class="line">        &#123;</span><br><span class="line">           </span><br><span class="line">            NSLog(@<span class="string">"%@"</span>,err);</span><br><span class="line">            [[Single sharedSingle].socket readDataWithTimeout:-1 tag:0];</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            [[Single sharedSingle].customStatueBar show];</span><br><span class="line">            [Single sharedSingle].customStatueBar.messageLabel.text=@<span class="string">"连接中..."</span>;</span><br><span class="line">            NSLog(@<span class="string">"ok"</span>);</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
            <div class='article_footer'>
              
                
  
    
    



  

  
    
    



  

  

  
    
    

<section class="widget qrcode  desktop mobile">
  

  <div class='content article-entry'>
    
      
        <div class='fancybox'><img src='https://qyanblog.oss-cn-shenzhen.aliyuncs.com/wechat_littleWhale.JPG'
        
          height='225px'
        ></div>
      
    
  </div>
</section>

  


              
            </div>
          
        </div>
        
          


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2020-05-27T09:11:12+08:00">
  <a class='notlink'>
    <i class="fas fa-edit fa-fw" aria-hidden="true"></i>
    <p>更新于：2020年5月27日</p>
  </a>
</div>

        
      
        
          

        
      
        
          

        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="" rel="external nofollow noopener noreferrer"
          
          href="http://connect.qq.com/widget/shareqq/index.html?url=http://gaoyingqiu.github.io/2016/05/15/xmpp/&title=Xmpp协议 - littleWhale&summary=基于TCP的长连接。在使用 TCP 长连接的 IM 服务设计中，往往都会涉及到心跳。心跳一般是指某端(绝大多数情况下是客户端)每隔一定时间向对端发送自定义指令，以判断双方是否存活，因其按照一定间隔发送，类似于心跳，故被称为心跳指令。"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qq.png">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="" rel="external nofollow noopener noreferrer"
          
          href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://gaoyingqiu.github.io/2016/05/15/xmpp/&title=Xmpp协议 - littleWhale&summary=基于TCP的长连接。在使用 TCP 长连接的 IM 服务设计中，往往都会涉及到心跳。心跳一般是指某端(绝大多数情况下是客户端)每隔一定时间向对端发送自定义指令，以判断双方是否存活，因其按照一定间隔发送，类似于心跳，故被称为心跳指令。"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qzone.png">
          
        </a>
      
    
      
        <a class="-mob-share-weibo" title="" rel="external nofollow noopener noreferrer"
          
          href="http://service.weibo.com/share/share.php?url=http://gaoyingqiu.github.io/2016/05/15/xmpp/&title=Xmpp协议 - littleWhale&summary=基于TCP的长连接。在使用 TCP 长连接的 IM 服务设计中，往往都会涉及到心跳。心跳一般是指某端(绝大多数情况下是客户端)每隔一定时间向对端发送自定义指令，以判断双方是否存活，因其按照一定间隔发送，类似于心跳，故被称为心跳指令。"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/weibo.png">
          
        </a>
      
    
  </div>
</div>



        
      
    </div>
  </section>


        
        
          <div class="prev-next">
            
              <a class='prev' href='/2016/05/16/iOSThread/'>
                <p class='title'><i class="fas fa-chevron-left" aria-hidden="true"></i>谈谈iOS的多线程</p>
                <p class='content'>ios线程形式有三种。 ios4后，苹果改用GCD多线程。线程可以用来干什么呢？多线程可以用来后台加载图片更新主线程UI,或者请求网络数据等等。
Thread使用 NSThread 来创建线程有...</p>
              </a>
            
            
              <a class='next' href='/2016/05/13/AFNNetWorking/'>
                <p class='title'>AFNNetWorking-分析<i class="fas fa-chevron-right" aria-hidden="true"></i></p>
                <p class='content'>基于ASI之后，AFN应该是比较流行的ios第三方。GIthub AFNetWorking.这里，先贴我之前做项目 基于AFN的封装。之后，解释下AFNetWorking 的相关知识，AFURL...</p>
              </a>
            
          </div>
        
      </section>
    </article>
  

  
    <!-- 显示推荐文章和评论 -->



  <article class="post white-box reveal comments shadow">
    <section class="article typo">
      <p ct><i class='fas fa-comments'></i> 评论</p>
      
      
      
      
      
      
        <section id="comments">
          <div id="valine_container" class="valine_thread">
            <i class="fas fa-cog fa-spin fa-fw fa-2x"></i>
          </div>
        </section>
      
      
    </section>
  </article>


  




<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: 'Xmpp协议',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
  

  
    
    


  <section class="widget toc-wrapper shadow desktop mobile">
    
  <header>
    
      <i class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name'>本文目录</span>
    
  </header>


    <div class='content'>
      <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#保持心跳的必要"><span class="toc-text">保持心跳的必要</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#为什么TCP-KeepAlive-不能用于检测"><span class="toc-text">为什么TCP KeepAlive 不能用于检测</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#心跳的做法"><span class="toc-text">心跳的做法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#消息可达"><span class="toc-text">消息可达</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#消息加密"><span class="toc-text">消息加密</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IM协议包"><span class="toc-text">IM协议包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IM聊天App-登录后要做得事情"><span class="toc-text">IM聊天App  登录后要做得事情</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用XMpp协议的一个聊天应用程序，当程序退到后台的时候，如果想要继续接收到聊天信息或icon显示badge-该怎么做？GCDAsyncSocket"><span class="toc-text">使用XMpp协议的一个聊天应用程序，当程序退到后台的时候，如果想要继续接收到聊天信息或icon显示badge, 该怎么做？GCDAsyncSocket</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#聊聊IOS后台"><span class="toc-text">聊聊IOS后台</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安排Local-Notification的传递"><span class="toc-text">安排Local Notification的传递</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#voip与socket实现后台推送"><span class="toc-text">voip与socket实现后台推送</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-找到该文件-添加该项"><span class="toc-text">1.找到该文件,添加该项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-在socket连接成功代理里面"><span class="toc-text">2.在socket连接成功代理里面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-在收到socket消息代理里面"><span class="toc-text">3.在收到socket消息代理里面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-挂起时，本操作是为了600秒重写连接一次socket，保持socket在线"><span class="toc-text">4.&#x2F;&#x2F;挂起时，本操作是为了600秒重写连接一次socket，保持socket在线</span></a></li></ol>
    </div>
  </section>


  

  
    
    
  

  <section class="widget related_posts shadow desktop mobile">
    
  <header>
    
      <i class="fas fa-bookmark fa-fw" aria-hidden="true"></i><span class='name'>相关文章</span>
    
  </header>


    <div class="content">
      <ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/08/11/brainMap/" title="巧用图解构思-百度脑图" rel="bookmark">巧用图解构思-百度脑图</a></h3></div></li></ul>
    </div>
  </section>


  


</aside>


  
  <footer class="clearfix">
    <br><br>
    
      
        <div class="aplayer-container">
          

  
    <meting-js
      theme='#1BCDFC'
      autoplay='true'
      volume='0.6'
      loop='all'
      order='random'
      fixed='false'
      list-max-height='340px'
      server='netease'
      type='playlist'
      id='4862553993'
      list-folded='true'>
    </meting-js>
  


        </div>
      
    
      
        <br>
        <div class="social-wrapper">
          
            
              <a href="mailto:qiugaoying@163.com"
                class="social fas fa-envelope flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://github.com/gaoyingqiu"
                class="social fab fa-github flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
        </div>
      
    
      
        <div><p>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
      
    
      
        本站使用
        <a href="https://volantis.js.org/" target="_blank" class="codename">Volantis</a>
        作为主题，总访问量为
          <span id="busuanzi_value_site_pv"><i class="fas fa-circle-notch fa-spin fa-fw" aria-hidden="true"></i></span>
          次
        
      
    
      
        <div class='copyright'>
        <p><a href="http://littleWhale.xyz" target="_blank" rel="noopener">Copyright © 2016-2020 高颖</a></p>

        </div>
      
    
  </footer>

<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4/dist/jquery.min.js"></script>


  <script>
    
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/" || "/";
    if (!ROOT.endsWith('/')) ROOT += '/';
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/instant_page.js" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>


  <script src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.6/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      ScrollReveal().reveal('.l_main .reveal', {
        distance: '8px',
        duration: '800',
        interval: '100',
        scale: '1'
      });
    });
  </script>


  
<script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>

  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script defer src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>



  
  
  
    
<script src="https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js"></script>

    <script type="text/javascript">
      $(function(){
        var imgs=["https://qyanblog.oss-cn-shenzhen.aliyuncs.com/IMG_0131.JPG", "https://qyanblog.oss-cn-shenzhen.aliyuncs.com/小恐龙.JPG"];
        if ('true' == 'true') {
          function shuffle(arr){
            /*From countercurrent-time*/
            var n = arr.length;
            while(n--) {
              var index = Math.floor(Math.random() * n);
              var temp = arr[index];
              arr[index] = arr[n];
              arr[n] = temp;
            }
          }
          shuffle(imgs);
        }
        if ('.cover') {
          $('.cover').backstretch(
            imgs,
          {
            duration: "10000",
            fade: "1500"
          });
        } else {
          $.backstretch(
            imgs,
          {
            duration: "10000",
            fade: "1500"
          });
        }
      });
    </script>
  



  
    
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js"></script>

  
    
<script src="https://cdn.jsdelivr.net/npm/meting@2.0/dist/Meting.min.js"></script>

  









  
    
<script src="https://cdn.jsdelivr.net/npm/valine@1.4/dist/Valine.min.js"></script>

  
  <script>
  var GUEST_INFO = ['nick','mail','link'];
  var meta = 'nick,mail,link'.split(',').filter(function(item){
    return GUEST_INFO.indexOf(item) > -1
  });
  var REQUIRED_FIELDS = ['nick','mail','link'];
  var requiredFields = 'nick,mail'.split(',').filter(function(item){
    return REQUIRED_FIELDS.indexOf(item) > -1
  });
  var valine = new Valine();
  function emoji(path, idx, ext) {
      return path + "/" + path + "-" + idx + "." + ext;
  }
  var emojiMaps = {};
  for (var i = 1; i <= 54; i++) {
    emojiMaps['tieba-' + i] = emoji('tieba', i, 'png');
  }
  for (var i = 1; i <= 101; i++) {
    emojiMaps['qq-' + i] = emoji('qq', i, 'gif');
  }
  for (var i = 1; i <= 116; i++) {
    emojiMaps['aru-' + i] = emoji('aru', i, 'gif');
  }
  for (var i = 1; i <= 125; i++) {
    emojiMaps['twemoji-' + i] = emoji('twemoji', i, 'png');
  }
  for (var i = 1; i <= 4; i++) {
    emojiMaps['weibo-' + i] = emoji('weibo', i, 'png');
  }
  valine.init({
    el: '#valine_container',
    meta: meta,
    
    appId: "OnQHqq8HNcQhfFFnTapHxBju-gzGzoHsz",
    appKey: "r0pJLLJPQqSWS9HO9MO5DkKq",
    placeholder: "快来评论吧~",
    pageSize:'10',
    avatar:'robohash',
    lang:'zh-cn',
    visitor: 'true',
    highlight: 'true',
    mathJax: 'false',
    enableQQ: 'true',
    requiredFields: requiredFields,
    emojiCDN: 'https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/emoji/valine/',
    emojiMaps: emojiMaps
  })
  </script>





  
<script src="/js/app.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.6.5/js/search.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/comment_typing.js"></script>






<!-- 复制 -->

  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="fas fa-copy"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-check-circle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('fa-check-circle');
          $icon.addClass('fa-copy');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-times-circle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('fa-times-circle');
          $icon.addClass('fa-copy');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>




<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  function pjax_fancybox() {
    $(".article-entry").find("img").not('.inline').not('a img').each(function () { //渲染 fancybox
      var element = document.createElement("a"); // a 标签
      $(element).attr("pjax-fancybox", "");  // 过滤 pjax
      $(element).attr("href", $(this).attr("src"));
      if ($(this).attr("data-original")) {
        $(element).attr("href", $(this).attr("data-original"));
      }
      $(element).attr("data-fancybox", "images");
      var caption = "";   // 描述信息
      if ($(this).attr('alt')) {  // 标准 markdown 描述信息
        $(element).attr('data-caption', $(this).attr('alt'));
        caption = $(this).attr('alt');
      }
      var div = document.createElement("div");
      $(div).addClass("fancybox");
      $(this).wrap(div); // 最外层套 div ，其实主要作用还是 class 样式
      var span = document.createElement("span");
      $(span).addClass("image-caption");
      $(span).text(caption); // 加描述
      $(this).after(span);  // 再套一层描述
      $(this).wrap(element);  // 最后套 a 标签
    })
    $(".article-entry").find("img").fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
      closeClick: true,
      helpers: {
        overlay: {closeClick: true}
      },
      buttons: [
        "zoom",
        "close"
      ]
    });
  };
  $(function () {
    pjax_fancybox();
  });
</script>




  <script>setLoadingBarProgress(100);</script>
</body>
</html>
